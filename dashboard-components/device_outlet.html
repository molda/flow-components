<style>
.dashboardoutlet .tablecell { height: 100%; display: table; width: 100%; color: white; }
.dashboardoutlet .content { display: table-cell; vertical-align: middle; text-align: center; cursor: pointer; padding-top: 3px; }
.dashboardoutlet .error { color: red; }
.dashboardoutlet .svg { margin: 0 auto; height: 50%; }
.dashboardoutlet .name { text-overflow: ellipsis; white-space: nowrap; overflow:hidden; padding-left: 3px; padding-right: 3px; margin: 0 auto; }
.dashboardoutlet .fa-spinquick { -webkit-animation: fa-spin 1s infinite linear; animation: fa-spin 1s infinite linear; }
</style>

<script type="text/html" settings>
	<div class="padding">
		<div class="m" data-jc="dropdown" data-jc-path="id" data-jc-config="required:true;datasource:common.instances;if:n => n.component === 'device_outlet';empty:">@(Flow instance)</div>
		<div data-jc="multioptions" data-jc-path="?">
			<script type="text/plain">
				option('background', 'Background Color', '#967ADC', 'Color');
				option('transparent', 'Transparent background', false);
			</script>
		</div>
	</div>
</script>

<script type="text/html" body>
<div style="height:100%">
	<div class="tablecell">
		<div class="content">
			<div class="spinner hidden" style="margin-top:-4px;margin-bottom:-4px;">
				<i class="fa fa-spinner fa-spinquick fa-fw"></i>
			</div>
			<div class="svg">
				<svg class="on hidden" viewBox="0 0 1000 1000" style="fill:#fff;">
					<path d="M322.8,500c0,28.8,23.4,52.1,52.1,52.1S427,528.8,427,500s-23.4-52.1-52.1-52.1S322.8,471.2,322.8,500z M573,500c0,28.8,23.4,52.1,52.1,52.1s52.1-23.4,52.1-52.1s-23.4-52.1-52.1-52.1S573,471.2,573,500z M10,906.6c0,46.1,37.3,83.4,83.4,83.4h813.2c46.1,0,83.4-37.3,83.4-83.4l0-813.2c0-46.1-37.3-83.4-83.4-83.4L93.4,10C47.3,10,10,47.3,10,93.4V906.6L10,906.6z M218.5,500c0-155.5,125.9-281.5,281.5-281.5S781.5,344.5,781.5,500S655.5,781.5,500,781.5S218.5,655.5,218.5,500z" />
				</svg>
				<svg class="off hidden" viewBox="0 0 1000 1000" style="fill:#fff;">
					<g transform="translate(0.000000,511.000000) scale(0.100000,-0.100000)">
						<path d="M1399.5,4985.4c-497.7-94.7-909.5-400.8-1120.9-828C84.9,3761,100.3,4122.1,100.3,107.7c0-3985.9-13.2-3651.1,163-4018.9c193.8-409.6,570.4-713.5,1037.2-841.2c134.3-37.4,361.1-39.6,3699.6-39.6c3990.2,0,3659.9-13.2,4018.9,165.2c332.5,163,552.7,383.2,715.7,715.7c178.4,358.9,165.2,28.6,165.2,4018.9c0,3338.4-2.2,3565.2-39.7,3699.6c-127.7,466.9-431.6,843.4-841.2,1037.2c-370,176.2-19.8,162.9-3952.8,167.4C2225.3,5014,1525.1,5009.6,1399.5,4985.4z M8514.6,4487.7c422.8-77.1,788.4-442.6,865.4-865.4c33-182.8,33-6846.4,0-7029.2c-77.1-422.8-442.7-788.4-865.4-865.5c-182.8-33-6846.4-33-7029.2,0c-422.8,77.1-788.4,442.6-865.4,865.5c-33,182.8-33,6846.4,0,7029.2c74.9,411.8,442.6,786.2,845.6,863.2C1628.6,4516.3,8345.1,4518.5,8514.6,4487.7z" />
						<path d="M4652.1,3146.6c-1052.6-134.3-1959.9-784-2404.7-1724.3c-132.1-279.7-182.8-431.6-244.4-722.3c-68.3-323.7-70.5-858.8-2.2-1180.3c266.5-1242,1169.3-2144.9,2411.3-2411.3c319.3-66.1,856.6-66.1,1175.9,0c1242,266.5,2144.9,1169.3,2411.3,2411.3c66.1,319.3,66.1,856.6,0,1175.9c-178.4,828-627.6,1497.4-1323.5,1966.5c-158.5,105.7-519.7,281.9-720.1,347.9C5594.6,3131.2,5017.6,3192.8,4652.1,3146.6z M5286.3,2640.1c1477.6-169.6,2508.2-1587.7,2211-3038.9c-171.8-836.8-784-1565.7-1561.3-1863c-971.1-369.9-2015-151.9-2735.1,574.8c-999.8,1008.6-999.8,2591.9,2.2,3591.7C3758,2461.7,4515.6,2728.2,5286.3,2640.1z" />
						<path d="M3524.6,594.3c-233.4-72.7-374.4-253.2-374.4-486.7c0-451.4,550.5-667.2,863.2-336.9c127.7,134.3,165.2,372.2,85.9,548.3C4004.7,528.3,3733.8,658.2,3524.6,594.3z" />
						<path d="M6233.2,594.3c-237.8-77.1-374.4-253.2-374.4-486.7c0-284.1,211.4-493.3,495.5-493.3c521.9,0,689.3,698.1,224.6,935.9C6482.1,600.9,6314.7,620.7,6233.2,594.3z" />
					</g>
				</svg>
			</div>
			<div class="name">Socket</div>
		</div>
	</div>
</div>
</script>

<script>
exports.name = 'outlet';
exports.title = 'Outlet';
exports.icon = 'fa-plug';
exports.author = 'Martin Smola';
exports.group = 'Devices';
exports.options = { background: '#967ADC' };
exports.version = '1.0.0';

exports.install = function(instance) {

	var type = '';
	var $name, $svg, $svgwrapper;
	var $on, $off, $spinner;
	var timeout = 0;

	instance.on('resize', function(size) {
		instance.element.css('font-size', ((size.height / 100) * 16) + 'px');
		$name.width(size.width - 10 + 'px');
		$svg.css('width', (size.height / 3) + 'px');
		$spinner.css('font-size', ((size.height / 3)) + 'px');
	});

	instance.on('data', function(response) {

		var options = instance.options;

		if (RELEASE && (!options.id || response.id !== options.id || (response.type !== 'status')))
			return;

		var device = response.body;

		var t2 = new Date().getTime() - 1000;
		if (timeout < t2) {
			doit();
		} else {
			setTimeout(doit, timeout - t2);
		}

		function doit() {
			$spinner.aclass('hidden');
			$svgwrapper.rclass('hidden');
			$on.tclass('hidden', !device.on);
			$off.tclass('hidden', !!device.on);
		}	
	});

	instance.reconfigure = function() {

		var options = instance.options;
		instance.transparent(options.transparent);
		instance.element.css('background-color', options.transparent ? 'transparent' : options.background);
		instance.emit('resize', instance.size);
		instance.options.id && instance.send(instance.options.id, 'status');
	};

	instance.make = function() {

		instance.element.addClass('dashboardoutlet');

		$name = instance.element.find('.name');
		$svg = instance.element.find('svg');
		$svgwrapper = instance.element.find('.svg');
		$on = instance.element.find('.on');
		$off = instance.element.find('.off');
		$spinner = instance.element.find('.spinner');

		instance.reconfigure();

		instance.element.on('click', function(){
			
			$svgwrapper.aclass('hidden');
			$spinner.rclass('hidden');
			timeout = new Date().getTime();

			setTimeout2(instance.id, function(){
				instance.options.id && instance.send(instance.options.id, 'click');
			}, 50);
		});	
	};

	instance.on('options', instance.reconfigure);
};
</script>
